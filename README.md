# E-Commerce-Webapp-with-Stripe-Sync

## 🌱 概要

アートに関わる物理・デジタル両方の商品を扱う EC サイト

## 🏠URL

https://art-sa2.com/

## ✨ ご利用ガイド

EC サイト利用時に操作方法を確認したい場合は、以下のリンクにアクセスしてください。

<!--
    【TODO】
    DEMO動画と使用方法を記載したマークダウンファイルへのリンク → DEMO.md
    項目は、仮記載なので変更する可能性あり。
    [#44](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/issues/44)でリンクを追記する
 -->

### 通常のユーザー

- [商品検索]()
- [ダークモードとライトモードの切り替え]()
- [ホームページへのアクセス]()
- [商品ページ]()
- [ウィッシュリスト(※1)]()
- [お気に入り(※1)]()
- [チャット(※1)]()
- [購入履歴(※1)]()
- [ダウンロードリスト(※1)]()
- [アカウント情報(※1)]()
- [アカウント作成]()
- [ログイン]()
- [ログアウト(※1)]()
- [お問い合わせ]()

### 管理者(通常のユーザーは、アクセスできません)

- [商品管理]()
- [発送管理]()
- [タグ一覧の確認と削除]()
- [ユーザーからのチャット対応]()

※1. ログインすると、機能を利用できます

## 📝 説明

このサイトは、アートに関わる物理・デジタル両方の商品を扱う EC サイトです。

このサイトでは、自社製品を販売する EC サイトとして以下の 3 種類のユーザーが利用することを想定して開発しました。

また、決済機能には、Stripe を利用していますが、デモサイトということもあり、テストモードで運用しています。

そのため、実際の金銭的なやり取りは発生しませんので、安心して商品購入を体験できます。

**ゲストユーザー**

アカウント作成不要で、EC サイトを利用できます。

商品の情報を確認して気に入った商品があれば購入することができます。

**ログインユーザー**

アカウントを作成してログインすることで、ログインユーザーになれます。

ログインユーザーは、商品の閲覧や購入だけでなく、補助的な機能が利用できるようになります。

機能の詳細については、[機能一覧](#機能一覧)を確認してください。

**管理者**

管理者は、EC サイトを運営するユーザーです。

管理者用ダッシュボードを利用して、商品管理や発送、ユーザーとのチャットなどを対応します。

通常のユーザーは、EC サイトを利用する際に意識する必要はありません。

### 注意事項

#### 商品購入時

商品ご購入時には、カード情報の入力が要求されます。

カード情報には、以下の情報を手動で入力してください。

| 項目                              | 内容                |
| --------------------------------- | ------------------- |
| カード番号                        | 4242 4242 4242 4242 |
| 有効期限(有効な将来の日付)        | 12/34               |
| セキュリティーコード(任意の 3 桁) | 123                 |

##### 参考

- [テストカードの使用方法](https://docs.stripe.com/testing?locale=ja-JP#use-test-cards)

#### 購入された商品について

デジタル商品を購入された場合は、zip 形式の画像をダウンロードすることができます。

画像には、著作権フリー画像や ChatGPT により生成された画像を使用していますが、インターネット上での利用はお控えください。

万が一、画像が流出した場合、その対応はご自身の責任となります。

ご了承ください。

#### 一部の機能について

以下の機能については、機能として完成していますが、運用することが難しいため、対応できない場合がございます。

ご理解いただけますようお願い申し上げます。

- お問い合わせ
- チャット
- 商品発送

## 💾 使用技術

<table>
<tr>
  <th>カテゴリ</th>
  <th>技術スタック</th>
</tr>
<tr>
  <td rowspan=5>フロントエンド</td>
  <td>HTML</td>
</tr>
<tr>
  <td>CSS</td>
</tr>
<tr>
  <td>TypeScript</td>
</tr>
<tr>
  <td>CSSのフレームワーク : Tailwind CSS</td>
</tr>
<tr>
  <td>Tailwind CSSのフレームワーク : Flowbite</td>
</tr>
<tr>
  <td rowspan=3>バックエンド</td>
  <td>Ruby v3.3.0</td>
</tr>
<tr>
  <td>Go v1.22</td>
</tr>
<tr>
  <td>フレームワーク : Ruby on Rails v7.1.3.2 (※2)</td>
</tr>
<tr>
  <td rowspan=10>インフラ</td>
  <td>Amazon EC2 (Ubuntu 24.04)</td>
</tr>
<tr>
  <td>Amazon RDS</td>
</tr>
<tr>
  <td>Amazon S3</td>
</tr>
<tr>
  <td>Docker (※3)</td>
</tr>
<tr>
  <td>Nginx v1.25.4</td>
</tr>
<tr>
  <td>HTTPS-PORTAL v1</td>
</tr>
<tr>
  <td>開発用メールサーバー : MailHog</td>
</tr>
<tr>
  <td>支払いゲートウェイ : Stripe</td>
</tr>
<tr>
  <td>Stripeの開発者向けツール : Stripe CLI v1.19.5</td>
</tr>
<tr>
  <td>GitHub Actions</td>
</tr>
<tr>
  <td>データベース</td>
  <td>MySQL v8.0.36</td>
</tr>
<tr>
  <td >デザイン</td>
  <td>Figma</td>
</tr>
<tr>
  <td rowspan=4>その他</td>
  <td>Git</td>
</tr>
<tr>
  <td>GitHub</td>
</tr>
<tr>
  <td>Docker Hub</td>
</tr>
<tr>
  <td>トークンベースの認証 : JWT</td>
</tr>
</table>

※2. 使用している Gem については、[Gemfile](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/src/Gemfile)を確認してください。

※3. 使用しているイメージについては、[環境ごとの一貫性と分離](#1-環境ごとの一貫性と分離)を確認してください。

## 🗄️ ソフトウェア設計

### ユースケース図

ソフトウェア設計の初期段階として、要件を整理するために、ユースケース図を作成しました。

これにより、ユーザーの種類やプロダクトとして必要な機能をイメージすることができました。

また、開発初期のイメージ共有として作成することが目的であったため、最新の EC サイトとは、異なる部分があります。

ユースケース図のコードは、[usecase.pu](https://github.com/recursion-backend-projects/dev-log/blob/main/usecase.pu)を確認してください。

![image](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/assets/119317071/652296d6-7b56-40c1-8d6f-c3a8d15f9316)

### フロントエンドデザイン

フロントエンドデザインとして、ユースケース図をもとに画面遷移図とモックアップページを作成しました。

これにより、開発時には、以下のようなメリットがありました。

- メンバー間での画面に関わるイメージを共有できる
- 統一されたデザインをビューにそのまま流用することができる

また、開発初期のイメージ共有として作成することが目的であったため、最新の EC サイトとは、異なる部分があります。

これらの設定ファイルについては、以下から確認してください。

- [画面遷移図](https://www.figma.com/design/4hgHQpmcFOFqZtoYaTyfX1/E-Commerce-Webapp-with-Stripe-Sync?node-id=0-1&t=aFkuO5gXDsB8dmWo-1)
- [モックアップページ](https://github.com/recursion-backend-projects/mockup-page)

### ER 図

ER 図は、Customer テーブルと Product テーブルをメインとして各機能に紐づく複数のテーブルで構成されています。

それぞれのテーブルには明確な役割が定義されているため、Rails のモデルやコントローラーの作成および更新が容易になりました。

また、プルリクエスト作成時には、ER 図も一緒に更新することをルール化していたため、短時間でデータベースの関係性を把握することができました。

実際の ER 図は、[er.md](https://github.com/recursion-backend-projects/dev-log/blob/main/er.md)を確認してください。

### インフラ構成図

本プロダクトのインフラは、AWS をメインとして　 GitHub Actions, Docker, Docker Hub で構成しました。

これらの技術を利用して、[CI/CD](#cicd)を構築しました。

これにより、開発工程が自動化されスムーズに開発を進めることができました。

実際の AWS のインフラ構成図は、[aws-architecture.md](https://github.com/recursion-backend-projects/dev-log/blob/main/aws-architecture.md)を確認してください。

## 👀 機能一覧

機能一覧の各イメージについは、[ご利用ガイド](#ご利用ガイド)に記載しているリンクを確認してください。

### 共通機能

| 機能                                 | 内容                                                                                                                                                                                                          |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ユーザー認証                         | アカウント作成やログイン、ログアウトなどの認証機能には、[devise](https://github.com/heartcombo/devise)という Gem を利用しています。<br>これにより、ユーザーの認証に関わる情報の管理と実装が可能になりました。 |
| ダークモードとライトモードの切り替え | ヘッダーの`カート`ボタン左にある切替ボタンでダークモードとライトモードの切り替えができます。<br>ローカルストレージの値を参照してどちらに切り替えるか処理しています。                                          |

### 通常のユーザー

| 機能                     | 内容                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 商品検索とフィルタリング | ヘッダーの検索欄を利用することで、検索ワードをもとに商品リストを表示します。<br>検索対象は、商品名、商品説明、作者、カテゴリー、タグに含まれる文字列です。<br>検索ワードを空欄で検索した場合は、すべての商品が商品リストの対象となります。<br>商品リストページのフィルターを利用して、目的の商品を絞り込むことが可能です。<br>この機能には、[ransack](https://github.com/activerecord-hackery/ransack)という Gem を利用しています。 |
| 各ページへのアクセス     | 各ページには、ヘッダーまたはフッターのボタンをクリックすることで、アクセスすることができます。<br>一部の機能は、ログインする必要があり、ゲストユーザーとして利用できない機能には、ボタンにカーソルを当てるとツールチップでメッセージが表示されます。                                                                                                                                                                                |
| 商品ページ               | 商品ページでは、商品に関わる情報を確認できます。<br>気に入った商品は、カートに追加したりすぐに購入することも可能です。<br>商品の購入を検討している場合は、ウィッシュリストやお気に入り、チャットやレビューなどの機能を利用することができます。<br>また、販売が終了した商品は、アクセスできませんので、ご注意ください。                                                                                                              |
| カートリスト             | カートリストは、購入を検討している商品を管理するリストです。<br>各ページの`カートに入れる`ボタンをクリックすると、カートに追加されます。<br>カートリストの商品は、`レジに進む`ボタンをクリックすると、まとめて購入することができます。<br>また、購入できない商品が含まれている場合は、`レジに進む`ボタンが表示されませんので、ご注意ください。                                                                                      |
| 商品購入                 | 各ページの`ご購入手続きへ`や`レジに進む`ボタンをクリックすると、支払いフォームのページが表示されます。<br>必要事項を入力後、`支払う`ボタンをクリックすると、商品の購入が確定されます。<br>この機能には、Stripe を利用しています。<br>詳細は、[Stripe](#Stripe) を確認してください。                                                                                                                                                 |
| ウィッシュリスト         | ウィッシュリストは、将来的に購入したい商品を記録しておくためのリストです。<br>機能としては、商品の数量変更、カートへの追加、購入、削除ができます。<br>また、他のユーザーとウィッシュリストを共有したい場合は、`リンクの共有`で URL をコピーできます。                                                                                                                                                                               |
| お気に入り               | お気に入りは、気に入った商品やよく見る商品を保存するためのリストです。<br>機能としては、商品の数量変更、カートへの追加、購入、削除ができます。                                                                                                                                                                                                                                                                                      |
| チャット                 | カスタマーサポートの担当者とチャットすることができます。<br>この機能には、Go で実装したマイクロサービスを利用しています。<br>マイクロサービスでは、JWT による認証と WebSocket によるリアルタイムなメッセージ共有が行われます。<br>詳細は、[マイクロサービス](#マイクロサービス) を確認してください。                                                                                                                                |
| 購入履歴                 | 購入履歴では、購入した商品をリストとして表示します。<br>機能としては、領収書の発行やレビューの作成/編集/削除ができます。<br>・領収書の発行は、Stripe が用意した対象商品の領収書を閲覧できます。<br>・レビューは、購入した商品を評価して投稿することができます。<br>　投稿したレビューは、商品ページのレビューに表示されます。                                                                                                       |
| ダウンロードリスト       | ダウンロードリストは、購入したデジタル商品のリストが表示されます。<br>`ダウンロード`ボタンをクリックすることで、zip 形式の画像をダウンロードすることができます。<br>不正防止のためリンクの期限は 30 日で切れるようになっていますので、ご注意ください。                                                                                                                                                                              |
| アカウント情報           | アカウント情報は、商品購入時の自動入力やお問い合わせに利用されます。<br>アカウント情報は、編集することができます。<br>また、デモサイトのため、氏名や電話番号、お届け先などの項目は、架空の情報でも問題ありません。                                                                                                                                                                                                                  |
| お問い合わせ             | お問い合わせは、EC サイトや商品に関わる質問について管理者へ問い合わせることができます。<br>入力フォームに必要事項を記入して送信すると、管理者へのお問い合わせのメールの送信と入力されたメールアドレスへ控えのメールが送信されます。<br>管理者はお問い合わせ内容を確認後に Gmail などのアプリケーションを利用して、入力されたメールアドレスへ返信するという流れになります。                                                          |

### 管理者

| 機能                  | 内容                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 商品管理              | 管理者用のログインフォームからログインすると、商品管理ページへアクセスできます。<br>商品管理ページでは、EC サイトに出品する商品の追加や編集、削除などができます。<br>商品を管理する際には、ステータスのフィルターやページネーション機能など補助的な機能を利用できます。<br>また、商品に関わるデータは、Stripe や Amazon S3 と同期させています。                                                                            |
| 発送管理              | 発送管理は、通常のユーザーが購入した物理商品の発送を管理します。<br>管理者が入力フォームで追跡番号を入力すると発送通知のメールが商品を購入したユーザーに送られます。<br>同時にステータスが未発送から発送済みに切り替わります。<br>また、補助的な機能としてステータスのフィルターも利用できます。                                                                                                                           |
| タグ一覧              | タグ一覧では、商品追加や編集時の入力フォームで設定したタグの確認と削除ができます。<br>タグの実装には、[acts-as-taggable-on](https://github.com/mbleigh/acts-as-taggable-on)という Gem を利用しています。                                                                                                                                                                                                                   |
| チャットリスト        | ユーザーからチャットがあると、チャットリストに表示されます。<br>チャットページにアクセスすると、リアルタイムでユーザーとのチャットが開始されます。<br>この機能には、Go で実装したマイクロサービスを利用しています。<br>マイクロサービスでは、JWT による認証と WebSocket によるリアルタイムなメッセージ共有が行われます。<br>詳細は、[マイクロサービス](#マイクロサービス) を確認してください。                             |
| DB の定期バックアップ | 障害が起きた際にデータを復元するため、cron を利用して DB のバックアップを実行するスクリプトを定期実行するようにしました。<br>バックアップは、Amazon S3 に保存され、古いバックアップファイルは削除するようにしています。バックアップに実行しているスクリプトは、[backup_to_s3.sh](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/src/bin/backup_to_s3.sh)を確認してください。　 |

## 📜 作成の経緯

[Recursion](https://recursionist.io/)というサービスで、コンピュータサイエンスとバックエンドについて学びました。

次の段階として、学んだ内容をアウトプットとして形にしたいという思いのユーザーが集まり、チーム開発を実施することになりました。

チーム開発を開始する前に、メンバー間で話し合いをした結果、様々な商品を扱えるアートを題材とした EC サイトを作成しようという話になりました。

また、チーム全体の技術意欲が高いことから、以下のポイントを考慮して開発を進めました。

未経験の技術がほとんどでしたが、無事リリースすることができました。

- [ソフトウェア設計](#%EF%B8%8Fソフトウェア設計)として、[ユースケース図](#ユースケース図)、[画面遷移図](#フロントエンドデザイン)、[ER 図](#ER図)、[インフラ構成図](#インフラ構成図) を実装開発サイクル前に作成する
- 開発チーム全体で同じ開発環境を共有するため、Docker を利用する
- 入力フォームの検証には、Rspec によるユニットテストを実装する<br>また、CI で自動テストを必ず実施することによりユニットテストをパスしていない機能追加を防止する
- [CI/CD](#cicd)パイプラインを構築することで開発工程を自動化する
- 支払いゲートウェイとして Stripe を使用する
- 管理者専用の E コマースダッシュボードから商品や発送の管理、ユーザーからのチャットに対応できるようにする
- チャットサービスは、ユーザーからのチャットに迅速に対応するため、マイクロサービスを Go で実装する

## ⭐ こだわった点

### CI/CD

本プロジェクトでは、各環境(ローカル、ステージング、本番)において効率的かつ安全に開発を進めるため、以下のポイントにこだわりました。

#### 1. 環境ごとの一貫性と分離

##### 環境ごとの設定ファイル

適切な設定が適用されるように`infra`ディレクトリ配下に各環境の設定ファイルを用意しました。

また、Docker の compose ファイルも各環境ごとにファイルを分けて管理するようにしました。

これらの設定ファイルについては、以下から確認してください。

**EC サイト**

- [infra](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/tree/main/infra)
- ローカル環境 : [compose.yml](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/src/compose.yml)
- ステージング環境 : [compose.stg.yml](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/src/compose.stg.yml)
- 本番環境 :[compose.prod.yml](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/src/compose.prod.yml)

**マイクロサービス**

- [infra](https://github.com/recursion-backend-projects/E-Commerce-Chat-Microservice/tree/main/infra)
- ローカル環境 : [compose.yml](https://github.com/recursion-backend-projects/E-Commerce-Chat-Microservice/blob/main/compose.yml)
- ステージング環境 : [compose.stg.yml](https://github.com/recursion-backend-projects/E-Commerce-Chat-Microservice/blob/main/compose.stg.yml)
- 本番環境 :[compose.prod.yml](https://github.com/recursion-backend-projects/E-Commerce-Chat-Microservice/blob/main/compose.prod.yml)

##### 環境変数の活用

セキュリティと柔軟性を考慮し、データベース接続情報や API キーなどの機密情報は環境変数で管理しました。

また、ステージング環境や本番環境の環境変数は、GitHub Secrets に登録した複数の変数を`.env`ファイルにまとめて、デプロイ時に渡すようにしました。

#### 2. CI/CD パイプラインの自動化

各環境の橋渡しとして GitHub Actions を利用しました。

これらの設定ファイルについては、以下から確認してください。

**EC サイト**

- [ci-cd.yml](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/.github/workflows/ci-cd.yml)
- [ci-cd-prod.yml](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/.github/workflows/ci-cd-prod.yml)

**マイクロサービス**

マイクロサービスの CI は、開発納期と工数の関係により省略しています。

- [cd-stg.yml](https://github.com/recursion-backend-projects/E-Commerce-Chat-Microservice/blob/main/.github/workflows/cd-stg.yml)
- [cd-prod.yml](https://github.com/recursion-backend-projects/E-Commerce-Chat-Microservice/blob/main/.github/workflows/cd-prod.yml)

##### 継続的インテグレーション

GitHub Actions を使用して、main ブランチへのプルリクエストまたはプッシュ時に自動でテストと Lint を実行しました。

これにより、コード品質を常に保ち開発することができました。

##### 自動デプロイ

ステージング環境と本番環境へのデプロイを自動化しました。デプロイ時のトリガーは、以下の通りです。

- ステージング : プルリクエストに関わる操作時(作成やレビューの指摘修正によるコミット)
- 本番環境 : リリースタグ作成時

##### ステージング環境でのレビュー

ステージング環境では、最新の機能や修正を確認しやすくするために、プルリクエストをトリガーとしてデプロイを行い、レビューをスムーズに進めることができるようにしました。

### マイクロサービス

この EC サイトでは、ユーザー体験とスケーリングをを向上させるために、チャット機能をマイクロサービスとして実装しています。チャット機能は、主にカスタマーサポートで管理者とユーザー同士のコミュニケーションを目的としています。このマイクロサービスは以下の技術スタックを活用しています：

- プログラミング言語: Go
- 認証: JWT (JSON Web Token)
- 通信プロトコル: WebSocket
- インフラ: Docker、AWS (EC2)
- 継続的デリバリー: GitHub Actions

**アーキテクチャ**

チャット機能は、Go で実装された独立したマイクロサービスとして提供されます。このサービスは、メインの Rails アプリケーションとは独立して動作し、特定の API エンドポイントと WebSocket を介して通信します。この分離により、チャット機能のスケーラビリティとメンテナンス性が向上しています。

[通信の全体図はこちら]()

**JWT による認証**

セキュリティ向上のために、JWT を使用してユーザー認証を行っています。JWT（JSON Web Token）は、ユーザーの認証情報を含むトークンを生成・検証するための標準規格です。ユーザーがチャットに接続する際、Rails アプリケーションから発行されたトークンを使用して認証を行います。このトークンは、ユーザー ID などの情報をペイロードに含み、 Go サーバー側でトークンの検証を行うことで、セキュアな通信を実現しています。

1. トークンの発行: ユーザーがチャットにアクセスすると、Rails アプリケーションが JWT を生成し、ユーザーに返します。このトークンは一定時間有効であり、その期間内はユーザーを再度認証することなく利用できます。
2. トークンの検証: ユーザーがチャットに接続する際、この JWT を Go サーバーに送信します。Go サーバーはトークンを検証し、ユーザーの認証情報を確認します。不正なトークンや期限切れのトークンは拒否されます。

**WebSocket によるリアルタイム通信**

チャットのリアルタイム性を確保するために、WebSocket を使用しています。WebSocket は、HTTP 通信とは異なり、クライアントとサーバー間で持続的な双方向通信を確立するプロトコルです。これにより、ユーザーは即座にメッセージを送受信することができます。WebSocket は、HTTP 通信に比べて低遅延かつ双方向の通信が可能なため、チャット機能に最適です。

1. 接続の確立: ユーザーがチャットページを開くと、WebSocket 接続が確立されます。これにより、サーバーとの間で常時接続が維持され、リアルタイムのデータ送受信が可能になります。
2. メッセージの送受信: ユーザーがメッセージを送信すると、WebSocket 経由でサーバーに送られ、即座に他のユーザーに配信されます。これにより、ほぼリアルタイムでのコミュニケーションが実現します。
3. 接続の維持と再接続: WebSocket 接続は、ネットワークの一時的な障害が発生しても自動的に再接続を試みます。これにより、ユーザーは途切れることなくチャットを続けることができます。

**Docker と AWS によるデプロイ**

チャットマイクロサービスは、Docker コンテナとして実行され、AWS の EC2 インスタンス上でホストされています。これにより、環境ごとの一貫性が保たれ、スケーラビリティも容易に実現できます。Docker を使用することで、開発環境と本番環境の違いを最小限に抑え、安定した動作を確保しています。

### Stripe

<!-- 【TODO】記載する -->

## 📑 開発について

- [スプリントスケジュール](https://github.com/recursion-backend-projects/dev-log/blob/main/sprint-schedule.md)
- [ミーティング議事録](https://github.com/recursion-backend-projects/dev-log/blob/main/README.md)
- [Git チュートリアル](https://github.com/recursion-backend-projects/dev-log/blob/main/git-tutorial.md)

## 🔑 ライセンス

[LICENSE](https://github.com/recursion-backend-projects/E-Commerce-Webapp-with-Stripe-Sync/blob/main/LICENSE)

## 👤 開発者及び著作者

- [seiichikick0404](https://github.com/seiichikick0404)
- [AkinoJoey](https://github.com/AkinoJoey)
- [Aki158](https://github.com/Aki158)
